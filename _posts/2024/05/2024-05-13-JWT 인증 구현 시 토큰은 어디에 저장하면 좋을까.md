---
layout: single
title: "JWT 인증 구현 시 토큰은 어디에 저장하면 좋을까?"
---
데이터 저장소별 장단점을 비교해보고 어떤 선택을 하면 좋을지 알아보자.


## 1. 상황 설정
새로 오픈하는 웹서비스에서 jwt 인증 방식을 도입하기로 하였다.  
인증용 토큰인 액세스 토큰과 액세스 토큰을 갱신할 수 있는 리프레시 토큰으로 나누어 운용하려 하는데 미리 고려해야 할 사항들을 체크해보려 한다.


##  2. 토큰은 어디에 저장하는게 좋을까?
클라이언트(브라우저)는 액세스 토큰과 리프레시 토큰을 어디에 저장해야 할까?  
토큰을 저장할 공간에 대해서 각각의 장단점을 비교해보자.  

### 2.1 쿠키
* 장점
  * 브라우저가 자동으로 요청 헤더에 추가해준다.
    * 헤더에 토큰을 추가하는 로직을 작성할 필요가 없다.
    * 브라우저를 리다이렉트 시킬 때 요청 헤더에 토큰을 포함 시킬 수 있다.
    * JS, CSS 등 정적 자원 로드 시 인증을 한 사용자에게만 접근을 허용할 수 있다. 
  * 추가적인 로직 작성 없이 속성 설정을 하는 것만으로 보안성을 높일 수 있다.    
    * HttpOnly : 자바스크립트로 토큰에 접근 할 수 없도록 할 수 있다.
    * Secure : HTTPS 에서만 전송되도록 강제할 수 있다.
    * 세션 쿠키 : 브라우저 종료 시 토큰이 자동으로 삭제되도록 할 수 있다.
* 단점
  * 보안을 위해 추가한 속성이 오히려 걸림돌이 될 수 있다.
    * HttpOnly : 자바스크립트로 토큰 만료시간을 체크해보고 싶은 경우 할 수가 없다.
  * 전송할 URL 과 아닌 URL 에 대해서 세밀한 제어가 어렵다.
    * Domain, Path 등 광범위한 제어만 가능하다.

### 2.2 로컬 스토리지
* 장점
  * 전송할 URL 과 아닌 URL 에 대해서 세밀한 제어가 가능하다.
    * 헤더를 수동으로 추가 해야하기 때문에 전송할 URL 일 때만 추가하면 된다.
  * 탭이 달라도 도메인 및 서브 도메인간에 토큰 공유가 가능하다.
* 단점
  * JS 에서 수동으로 요청 헤더에 추가해주어야 한다.
    * 브라우저를 리다이렉트 시킬 때 헤더에 토큰을 추가할 방법이 없다.
    * 인증이 된 사용자에게만 정적 자원 접근을 허용해야 하는 경우 구현이 복잡해진다.
      * EX) 헤더에 토큰을 추가하여 ajax 요청하고 응답 받으면 DOM 에 추가하고...
    * XSS 공격에 노출될 수 있다.
  * 세션 쿠키의 라이프 사이클을 모방해야 할 경우의 단점
    * 종료 이벤트에서 수동으로 클리어를 해야하므로 브라우저가 비정상 종료될 시에 데이터가 남아있을 수 있다.
* 장점 or 단점
  * 브라우저가 종료되어도 저장한 데이터는 사라지지 않고 보존된다.
  
### 2.3 세션 스토리지
* 장점
  * *(로컬 스토리지와 동일) 전송할 URL 과 아닌 URL 에 대해서 세밀한 제어가 가능하다.*
* 단점
  * *(로컬 스토리지와 동일) JS 에서 수동으로 요청 헤더에 추가해주어야 한다.*
  * 서브 도메인과 공유되지 않으므로 서브 도메인에서는 별도로 로그인이 필요하다.
  * 같은 탭 내에서만 공유되기 때문에 발생하는 문제점이 있다.
    * 로그인한 상태로 탭을 추가하면 새 탭에서도 다시 로그인을 해야한다.
    * A탭에서 로그아웃을 하면 A탭만 로그아웃되고 B탭은 로그인이 유지된다.
* 장점 or 단점
  * 탭이 닫히면 자동으로 데이터가 클리어 된다.

### 2.4 메모리
* 장점 
  * *(로컬 스토리지와 동일) 전송할 URL 과 아닌 URL 에 대해서 세밀한 제어가 가능하다.*
  * XSS 공격 예방이 가능하다.
    * 지역 변수에 토큰을 저장하는 등 XSS 공격으로 접근이 불가능한 위치에 저장이 가능하다. 
* 단점
  * *(로컬 스토리지와 동일) JS 에서 수동으로 요청 헤더에 추가해주어야 한다.*
  * *(세션 스토리지와 동일) 서브 도메인과 공유되지 않으므로 서브 도메인에서는 별도로 로그인이 필요하다.*
  * *(세션 스토리지와 동일) 같은 탭 내에서만 공유되기 때문에 발생하는 문제점이 있다.*
  * 페이지 이동이나 새로고침을 하면 데이터가 소실된다.
* 장점 or 단점
  * *(세션 스토리지와 동일) 탭이 닫히면 자동으로 데이터가 클리어 된다.*

  
## 3. 정리
위의 내용을 표로 정리해보면 아래와 같다.  
△ 표시는 구현 방법에 따라서 O 또는 X 가 될 수 있다는 의미이다.

| 기능                 | &nbsp;&nbsp;&nbsp;&nbsp;쿠키&nbsp;&nbsp;&nbsp;&nbsp; | 로컬 스토리지 | 세션 스토리지 | &nbsp;&nbsp;&nbsp;메모리&nbsp;&nbsp;&nbsp; |
|--------------------|:--------------------------------------:|:------------:|:------------:|:-----:|
| 자동으로 헤더에 추가됨       |                   O                    |      X       |      X       |   X   |
| 세밀한 URL 제어 가능      |                   X                    |      O       |      O       |   O   |
| XSS에 안전함           |                   △                    |      X       |      X       |   △   |
| 탭 및 서브 도메인 간 공유 가능 |                   O                    |      O       |      X       |   X   |
| 브라우저 종료 시 데이터 삭제   |                   △                    |      X       |      O       |   O   |
| 탭 종료 시 데이터 삭제      |                   X                    |      X       |      O       |   O   |
| 새로고침 시 데이터 삭제      |                   X                    |      X       |      X       |   O   |



## 4. 결론
* 리프레시 토큰 
  * 브라우저 종료 시 삭제하지 않으려면 쿠키와 로컬 스토리지 중에서 선택하면 될 것 같다.
  * 브라우저 종료 시 삭제를 해야 한다면 세션 쿠키에 저장하는 것이 가장 좋아보인다. 
    * 세션 스토리지와 메모리는 탭 및 서브 도메인 간 공유가 되지 않기 때문이다.
    * 로컬 스토리지의 경우 이벤트 리스너에서 토큰을 삭제하는 식으로 구현을 해야 할텐데  
      비정상 종료 시에는 동작하지 않기 때문이다.

* 액세스 토큰
  * 대부분의 요청에 필요하다는점에서 보면 자동으로 헤더에 추가되는 쿠키에 저장하는 것이 좋아보인다.
  * 토큰이 필요한 URL 을 세밀하게 제어해야 하는 경우 쿠키를 제외한 나머지 중에서 선택해야 한다.
    * 세션 스토리지 또는 메모리에 저장하게 되면 로그아웃 구현이 번거로울 수 있다.
    * 이 경우는 로컬 스토리지에 저장하는 것이 무난해보인다.